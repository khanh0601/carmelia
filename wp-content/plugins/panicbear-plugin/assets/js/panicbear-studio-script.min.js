jQuery(function ($) {
    var page = 1 // Current page number
    var maxPage = 1 // The maximum number of pages the current query can return
    var loading = false
    var category_id = null
    var $loadMoreButton = $('.load-more-button')
    var $postContainer = $('.blog-listing-grid')
    var $pagination = $('.blog-grid-pagination-ajax')

    $(document).on('click', '.blog-listing-nav-tabs .nav-item', function (e) {
        e.preventDefault()
        if (!loading) {
            loading = true
            const _this = $(this)
            const data_room_type = _this.data('room-type')
            category_id = data_room_type
            page = 1
            var data = {
                action: 'load_more_posts',
                paged: page,
                category_id: category_id,
            }

            $postContainer.html('<div class="text-loading">Loading...</div>')
            $pagination.html('')

            $.ajax({
                url: ajax_object.ajaxurl,
                type: 'post',
                data: data,
                success: function (response) {
                    const { data, status, total_pages, pagination } =
                        JSON.parse(response)
                    if (status === 'success') {
                        $postContainer.html(data)
                        $pagination.html(pagination)
                        loading = false
                        maxPage = total_pages
                    }
                },
            })
        }
    })

    $(document).on('click', '.blog-grid-pagination-ajax a', function (e) {
        e.preventDefault()
        if (!loading) {
            loading = true
            const _this = $(this)
            const data_page = _this.parent('[data-page]').data('page')
            if (data_page === 'pre') {
                page = page - 1
            } else if (data_page === 'next') {
                page = page + 1
            } else {
                page = data_page
            }
            _this.parents('.blog-grid-pagination-ajax').find('[data-page="' + page +'"]').addClass('active').siblings().removeClass('active')

            if (page > 1) {
                _this
                    .parent()
                    .siblings('[data-page="pre"]')
                    .removeClass('disabled')
            } else {
                _this
                    .parent()
                    .siblings('[data-page="pre"]')
                    .addClass('disabled')
            }

            if (page < maxPage) {
                _this
                    .parent()
                    .siblings('[data-page="next"]')
                    .removeClass('disabled')
            } else {
                _this
                    .parent()
                    .siblings('[data-page="next"]')
                    .addClass('disabled')
            }

            var data = {
                action: 'load_more_posts',
                paged: page,
                category_id: category_id,
            }

            $postContainer.html('<div class="text-loading">Loading...</div>')

            // scroll to blog-listing-grid
            $('html, body').animate(
                {
                    scrollTop: $postContainer.offset().top - 100,
                },
                300
            )

            $.ajax({
                url: ajax_object.ajaxurl,
                type: 'post',
                data: data,
                success: function (response) {
                    const { data, status, total_pages, pagination } =
                        JSON.parse(response)
                    console.log('data', total_pages)
                    if (status === 'success') {
                        $postContainer.html(data)
                        loading = false
                    }
                },
            })
        }
    })

    let searchTimeout = null;

    $(document).on('keyup', '#search-blog-post', function (e) {
        const _this = $(this)
        const value = _this.val()
        // sau khi người dùng dừng nhập 300ms thì mới gửi request
        if(searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function () {
            if (!loading) {
                loading = true
                page = 1
                var data = {
                    action: 'load_more_posts',
                    paged: 1,
                    search: value,
                    category_id: category_id,
                }

                $postContainer.html('<div class="text-loading">Loading...</div>')
                $pagination.html('')

                $.ajax({
                    url: ajax_object.ajaxurl,
                    type: 'post',
                    data: data,
                    success: function (response) {
                        const { data, status, total_pages, pagination } =
                            JSON.parse(response)
                        if (status === 'success') {
                            $postContainer.html(data)
                            $pagination.html(pagination)
                            loading = false
                            maxPage = total_pages
                        }
                    },
                })
            }
        }, 300)
    });
	
    // click blog-detail table of content scroll to section
    $(document).on('click', '.blog-detail .article-main-sidebar-table-of-content a', function (e) {
        e.preventDefault()
        const _this = $(this)
        const href = _this.attr('href')
        const $target = $(href)
		
        if ($(window).width() < 991) {
            $('html, body').animate(
                {
                    scrollTop: $target.offset().top - 70,
                },
                300
            )
        } else {
            $('html, body').animate(
                {
                    scrollTop: $target.offset().top - 70,
                },
                300
            )
        }
    })
})
